<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Xketch Linking Page</title>
    <!-- BLOCK: Loading libraries -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
    <script src="//www.parsecdn.com/js/parse-1.3.2.min.js"></script>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
    <!-- ENDBLOCK: Loading libraries -->

</head>
<body background="background.png">
    <!-- BLOCK: FB SDK initialization -->
    <div id="fb-root"></div>
    <script>
    Parse.initialize("AlRQDPdp00oyrwQfkvM5o1Dtes2tx26KLtNOLUvu", "w0STHGHcaw5POX5g5CEYb7k3isNaTs6cW7yury0v");
    var userName;
var userFacebookID;
    window.fbAsyncInit = function() {
        FB.init({
          appId      : '393710607445470',
          xfbml      : true,
          version    : 'v2.2'
      });
        FB.getLoginStatus(function(response) {
            statusChangeCallback(response);
        });
    };
    function statusChangeCallback(response) {
        console.log('statusChangeCallback');
        console.log(response);
        if (response.status === 'connected') {
            testAPI();
        } else {
            clean();
        }
    }
    function checkLoginState() {
        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
      });
    }

  // Load the SDK asynchronously
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    function testAPI() {
    console.log('Welcome!  Fetching your information.... ');
        FB.api('/me', function(response) {
          console.log('Successful login for: ' + response.name);
          console.log(JSON.stringify(response));
          userName = response.name;
          userFacebookID = response.id;
          getTokenFromParse();
          document.getElementById('my-profile-name').innerHTML = response.name +" Welcome!" ;
        });
    }
    function clean(){
        console.log("clean");
        document.getElementById('my-profile-name').innerHTML = "";
    }
    function getTokenFromParse(){
        var url = window.location.toString();
        var str = "";

        if (url.indexOf("?") != -1) {
            var str=url.split("?")[1];
            console.log(str+'\n');
        }
        addUserToTesterList(str);

    }
    function addUserToTesterList(objectid){
        var Project = Parse.Object.extend("XMLFile");
        var query = new Parse.Query(Project);
        query.equalTo("objectId",objectid);
        query.find({
            success: function(results){
                // alert("Successfully retrieved " + results.length + " scores.");
                for (var i = 0; i < results.length; i++) {
                  var object = results[i];
                  var testerList = object.get('TestUsers');
                  var isTester = 0;
                  for(var i =0; i < testerList.length ; i++){
                    console.log(testerList[i]+"  "+userFacebookID);
                    if(testerList[i]== userFacebookID){ 
                        alert("Already in "+object.get('ProjectName'));
                        isTester = 1;
                        break;
                    }
                  }
                  if(isTester == 0){
                    testerList[testerList.length] = userFacebookID;
                    object.set("TestUsers",testerList);
                    object.save();
                    alert("Join to Project "+object.get('ProjectName')+ " success");
                  }
                }
            },
            error: function(error){
                alert("Error: " + error.code + " " + error.message);
            }
        });
    }
    
</script>
<!-- ENDBLOCK: FB SDK initialization -->

<!-- BLOCK: Your playground -->

<!-- Button for login to Facebook -->
<div id="my-html-playground" class="container">
    <h1 align="center">Please Login Your Facebook</h1>
    <div id="my-login-control" align="center">
        <p id="my-login-message"></p>
        <div class="fb-login-button" data-max-rows="2" data-size="xlarge" data-show-faces="false" data-auto-logout-link="true" onlogin="checkLoginState();"></div>
    </div>
    <!-- Profile Area -->
</div>
<div id="my-profile" class="row" >
    <div align = "center">
        <p style="font-size:20px" id = "my-profile-name"></p>
<!--         <dl >
            <dt style="font-size:20px" >Welcome!</dt>
            <dd  style="font-size:16px" id="my-profile-name">aaa</dd>
        </dl> -->
    </div>
</div> 
<!-- ENDBLOCK: Your playground -->

<!-- BLOCK: Your script playground -->
<script id="my-script-playground">

window.fbLoaded = function(){
    // define the events when login status changed.
    FB.Event.subscribe('auth.login', function(response) {
        // when user has been logged in, this block will be triggered.
        var msg = "You're logged in.";
        $("#my-login-message").html(msg);
        console.log("Your login response:");
        console.log(response);
        fetch_my_profile();
    });
    console.log("fbloaded");
};
    // define the action when user clicked the login button.
    $("#my-login-button").click(function(){
        FB.login();
    });
    // send me a friend request by using Facebok Friends Dialog
</script>
    <!-- ENDBLOCK: Your script playground -->
</body>
</html>
